# 저장소 설명
인프런 `스프링부트로 직접 만들면서 배우는 대규모 시스템 설계` 실습 및 메모 저장소

# 메모
## Distributed Relational Database
- 서비스가 성장하면서 처음에는 DB를 `scale up` 할 수 있다. 
- 서비스가 더울 활성화 되면서 DB를 올리는것은 한계가 있기 때문에 이때는 `Scale out`을 고려할 수 있다. 
- 샤딩: 데이터를 데이터베이스에 분산해서 저장하는 기술
   - 수직 샤딩(vertical sharding): 데이터를 칼럼 단위로 수직 분할 하는 방식
   - 수평 샤딩(horizontal sharding): 데이터를 행 단위로 수평 분할 하는 방식
      - 데이터의 분리로 조인 또는 트랜잭션 관리가 복잡해진다
      - 수직 샤딩에 비해서 수평적 확장에 이점이 있다. 
   - 구체적 적용
      - 범위 기반 샤딩 (range based sharding)
         - shard key를 기준으로 범위를 지정해서 저장하는 방식
         - 데이터 쏠림 현상이 있을 수 있다. 
      - 해시 기반 샤딩 (hash-based sharding)
         - shard key의 해시 함수에 따라 분할 저장하는 방식
         - 균등한 분산을 위한 shard key와 해시 함수가 필요하다.
         - 범위 데이터 조회에 분리할 수 있다. 
      - 디렉토리 기반 샤딩 (directory-based sharding)
         - 매핑 테이블을 이용해서 각 데이터가 저장된 샤드를 관리한다. 
   - 물리적인 샤드가 늘어날 경우 데이터 재배치가 발생할 수 있다. 
   - 데이터의 안정성을 위해서 복제본을 두도록 한다. 

## Primary key 선택
- 분산환경을 고려할 경우에는 pk 선택을 잘 고려해야한다. 
- Snowflake
   - 분산 시스템에서 고유한 64비트 ID를 생성하는 알고리즘
      - 41비트: 시간 정보
      - 10비트: 노드 아이디
      - 12비트: 시퀀스
   - 시간 정보 + 노드 정보가 포함되기 때문에 분산환경에서 사용하기 적절하다. 

## 좋아요 기능 구현
- 테이블 설계
   ```
   id pk
   article_id 
   user_id
   created_at

   uk. article_id, user_id
   ```

- 좋아요 수 설계
   - 게시글 별 좋아요 수는 매번 전체를 좋아하는게 아니라, 별도로 비정규화해서 관리한다. 
   - 이때 게시글 테이블에 칼럼을 추가하는 거슬 고려할 수 있는데, 2개의 테이블은 성격이 다르다. 
      - 게시글은 작성한 사용자가 쓰기를 수행하고, 트래픽은 상대적으로 적다. 
      - 좋아요 수는 조회한 사용자들이 쓰기를 수행하고, 트래픽은 상대적으로 많다. 
      - 서로 다른 주체에 의해서 레코드 락이 잡힐 수 있다. 
   - 좋아요와 좋아요수 데이터의 일관성을 위해서는 같은 트랜잭션으로 구현해야 한다. 분산 시스템이라면 분산 트랙잭션을 고려해야 한다. 
   - 쓰기 트래픽이 많으면 동시성 문제가 발생할 수 있다. 
      1. 비관적 락
         1. update 구문
            - 락 점유 시간이 상대적으로 짧다
            - SQL 문을 직접 작성해야 한다. 
         2. select for update + update 구문
            - 락 점유 시간이 상대적으로 길다
            - JPA를 사용하는경우 상대적으로 객체지향스럽게 개발할 수 있다. 
      2. 낙관적 락
         - 충돌 발생에 대한 추가 작업이 필요하다. 예: 재시도
      3. 비동기 순차처리

## 조회수 기능 구현
- 설계
   - 데이터 일관성이 비교적 덜 중요하다. 불일치가 발생해도 사용자가 인지하기가 어렵다. 
   - 트래픽이 많다.
   - 이를 바탕으로 메모리 DataBase를 고려해본다. 
   - 데이터 백업
      - 시간 단위 백업
      - 개수 단위 백업
   - 어뷰징 케이스
      - 특정 사용자가 조회수를 비정상적으로 올릴 경우에 대한 고려
      - 사용자별로 Redis에 TTL을 이용해서 처리할 수 있다. 

## 인기글
- 개념
   - 일 단위로 상위 10건 인기글 선정. 매일 오전 1시 업데이트
   - 좋아요 수, 댓글 수, 조회 수 기반 점수 계산 
   - 최근 7일 내역 조회
- 설계
   - 방법
      1. 배치를 통한 접근
      2. 스트림 처리
   - 스트림 처리
      - 각 이벤트를 실시간으로 받아서 처리하는 방식으로 접근한다. 
      1. 각 서비스가 이벤트를 발행
      2. 인기글 서비스에서 이벤트를 받아서 계산
      3. 데이터에 저장. 저장 공간은 Redis의 zset을 이용한다. 
   - zset
      - key: yyyyMMdd
      - value: articleId
      - score: 각 글의 점수
- 이벤트
   - 
